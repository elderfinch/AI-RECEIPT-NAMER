<!DOCTYPE html>
<html data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Receipt Sorter</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* Small tweaks for a cleaner layout */
        .preview-pane {
            height: 80vh;
            position: sticky;
            top: 2rem;
        }
        .table-container {
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-base-200">

    <dialog id="api-key-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Enter Your Gemini API Key</h3>
            <p class="py-4">This app runs 100% in your browser. Your API key is saved *only* in your browser's <strong>localStorage</strong> and is never sent to any server except Google's AI API.</p>
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Gemini API Key</span>
                </label>
                <input class="input input-bordered w-full" type="password" id="api-key-input" placeholder="Paste your key here">
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" id="save-key-button">Save and Start</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <div id="main-content" class="hidden">
        
        <div class="hero min-h-64 bg-primary text-primary-content">
            <div class="hero-content text-center">
                <div class="max-w-md">
                    <h1 class="text-5xl font-bold">ðŸ¤– AI Receipt Sorter</h1>
                    <p class="py-6">Using <strong>Gemini</strong> to do the hard work. 100% in your browser, 100% fun.</p>
                </div>
            </div>
        </div>

        <div class="container mx-auto p-6">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex flex-col md:flex-row gap-4 items-center">
                        <input type="file" id="file-input" class="file-input file-input-bordered file-input-primary w-full" accept=".pdf" />
                        <button class="btn btn-primary btn-lg" id="process-button" disabled>
                            <span id="btn-text">Start Processing</span>
                            <span id="btn-loader" class="loading loading-spinner hidden"></span>
                        </button>
                    </div>

                    <div id="status-container" class="hidden mt-4">
                        <progress class="progress progress-primary w-full" id="progress-bar" max="100"></progress>
                        <p class="text-center" id="status-text">Processing...</p>
                    </div>
                </div>
            </div>

            <div id="results-section" class="hidden mt-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">Review and Edit Receipts</h2>
                            <div class="table-container overflow-x-auto">
                                <table class="table table-zebra w-full">
                                    <thead>
                                        <tr>
                                            <th>Amount</th>
                                            <th>Currency</th>
                                            <th>Merchant Name</th>
                                            <th>Line Item</th>
                                            <th>Chart of Accounts</th>
                                            <th>Preview</th>
                                        </tr>
                                    </thead>
                                    <tbody id="results-table-body">
                                        </tbody>
                                </table>
                            </div>
                            <button class="btn btn-success btn-lg mt-6" id="download-zip-button">
                                <span class="text-xl">ðŸ“¦</span>
                                Download Final ZIP
                            </button>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-1 preview-pane">
                        <div class="card bg-base-100 shadow-xl h-full">
                            <div class="card-body p-4">
                                <h2 class="card-title">Page Preview</h2>
                                <iframe id="pdf-preview" class="w-full h-full rounded-lg bg-gray-100" title="PDF Preview Pane"></iframe>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. IMPORT LIBS (from window) ---
        const { PDFDocument } = PDFLib;
        const { createWorker: createTesseractWorker } = Tesseract;
        const JSZip = window.JSZip;
        const { pdfjsLib } = window;
        
        // **THE FIX**: Set the path for the pdf.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- 2. CHART OF ACCOUNTS (From your PDF) ---
        const CHART_OF_ACCOUNTS_MAP = [
            { number: "000 50XX", name: "Employee Expenses" },
            { number: "000 5102", name: "Travel - Admin" },
            { number: "000 5170", name: "Vehicle Gasoline" },
            { number: "000 5200", name: "Operating Materials and Supplies" },
            { number: "000/025* 5221", name: "Teaching Literature and Supplies" },
            { number: "000 5370", name: "Telephone and Internet" },
            { number: "000/025* 5379", name: "Postage and Mailing" },
            { number: "000 5461", name: "Bank Fees" },
            { number: "000 5496", name: "Luncheons, Socials, and Hosting" },
            { number: "000 5500", name: "Miscellaneous" },
            { number: "000 5700", name: "Small Office Equipment" },
            { number: "000 5776", name: "Small Office Equipment Maintenance" },
            { number: "000 5860", name: "Small Purchases/Services for Mission Home/Office" },
            { number: "000 5862", name: "Rent - Admin" },
            { number: "000 5868", name: "Utilities - Admin" },
            { number: "400/425 5102", name: "Travel - In field" },
            { number: "400 5221", name: "Book of Mormon (IMOS orders only)" },
            { number: "400/425+ 5700", name: "Furnishings - Young Missionaries" },
            { number: "400/425+ 5862", name: "Rent - Young Missionaries" },
            { number: "400/425+ 5868", name: "Utilities - Young Missionaries" },
            { number: "400/425 5920", name: "Charitable Assistance" },
            { number: "400/425 5930", name: "Food and Personal Items" },
            { number: "480/485+ 5370", name: "Internet - Senior Missionaries" },
            { number: "480/485+ 5700", name: "Furnishings - Senior Missionaries" },
            { number: "480/485+ 5862", name: "Rent - Senior Missionaries" },
            { number: "480/485+ 5868", name: "Utilities - Senior Missionaries" },
            { number: "600 5480", name: "Vehicle Taxes and Fees" },
            { number: "600 5700", name: "Vehicle Equipment" },
            { number: "600 5772", name: "Vehicle Maintenance and Repairs" },
            { number: "900 1020", name: "Mission Bank Account" },
            { number: "900 1096", name: "Cash Transfers Clearing" },
            { number: "900 1200", name: "Petty Cash" },
            { number: "900 1220", name: "Working Fund" },
            { number: "900 1300", name: "Missionary Accounts Receivable" },
            { number: "900 1925", name: "Security Deposits" },
            { number: "900/925 5102", name: "Travel - Baggage, Visa and Other" },
            { number: "900/925 5949", name: "Missionary Medical" },
            { number: "6XXX 990 5462", name: "Gain/Loss on Exchange" }
        ];

        // Your preferred line items
        const PREFERRED_CATEGORIES = [
            "FURNISHINGS",
            "DIESEL FUEL",
            "FOOD FOR CONFERENCE",
            "TRAVEL MEAL",
            "NIGHTS AT HOTEL",
            "OFFICE SUPPLIES",
            "MISSIONARY TRAVEL"
        ];
        
        // --- 3. GLOBAL VARIABLES ---
        let tesseractWorker = null;
        let allPageBytes = []; // Stores the raw PDF data for each page
        let currentApiKey = null;

        // --- 4. DOM ELEMENTS ---
        const apiKeyModal = document.getElementById('api-key-modal');
        const saveKeyButton = document.getElementById('save-key-button');
        const apiKeyInput = document.getElementById('api-key-input');
        const mainContent = document.getElementById('main-content');
        const fileInput = document.getElementById('file-input');
        const processButton = document.getElementById('process-button');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const statusContainer = document.getElementById('status-container');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const resultsSection = document.getElementById('results-section');
        const tableBody = document.getElementById('results-table-body');
        const pdfPreview = document.getElementById('pdf-preview');
        const downloadZipButton = document.getElementById('download-zip-button');

        // --- 5. API KEY HANDLING ---
        function checkApiKey() {
            const key = localStorage.getItem('gemini_api_key');
            if (key) {
                currentApiKey = key;
                apiKeyModal.close();
                mainContent.classList.remove('hidden');
            } else {
                apiKeyModal.showModal();
            }
        }

        saveKeyButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                checkApiKey();
            }
        });

        // --- 6. FILE HANDLING & PROCESSING ---
        fileInput.addEventListener('change', (e) => {
            if (fileInput.files.length > 0) {
                processButton.disabled = false;
            } else {
                processButton.disabled = true;
            }
        });

        processButton.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) return;

            // Reset UI
            setLoading(true);
            statusContainer.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            tableBody.innerHTML = '';
            allPageBytes = [];

            try {
                // Step 1: Init Tesseract
                statusText.textContent = "Loading OCR Engine...";
                if (!tesseractWorker) {
                    tesseractWorker = await createTesseractWorker('por+eng', 1);
                }

                // Step 2: Split PDF and Run OCR on all pages
                statusText.textContent = "Splitting PDF document...";
                const fileBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(fileBuffer);
                const numPages = pdfDoc.getPageCount();
                progressBar.value = 0;
                progressBar.max = numPages;

                let ocrBatch = []; // <-- NEW: Array to hold all OCR text

                for (let i = 0; i < numPages; i++) {
                    const pageNum = i + 1;
                    statusText.textContent = `Processing Page ${pageNum} of ${numPages}...`;

                    // A. Create a 1-page PDF
                    const subDoc = await PDFDocument.create();
                    const [copiedPage] = await subDoc.copyPages(pdfDoc, [i]);
                    subDoc.addPage(copiedPage);
                    const pdfBytes = await subDoc.save();
                    allPageBytes.push(pdfBytes); // Save bytes for later

                    // B. Convert PDF page to Image
                    statusText.textContent = `Page ${pageNum}: Converting to image...`;
                    const imageBase64 = await convertPdfPageToImage(pdfBytes);

                    // C. Run OCR
                    statusText.textContent = `Page ${pageNum}: Reading text (OCR)...`;
                    const { data: { text: ocrText } } = await tesseractWorker.recognize(imageBase64);
                    
                    // D. <-- NEW: Add to batch instead of calling API
                    ocrBatch.push({
                        id: i, // Use the index as the ID
                        text: ocrText
                    });
                    
                    progressBar.value = pageNum;
                }

                // Step 3: <-- NEW: Run ONE Gemini call for the whole batch
                statusText.textContent = `Analyzing all ${numPages} receipts with AI... (this may take a moment)`;
                const prompt = buildLLMBatchPrompt(ocrBatch); // <-- NEW function call
                console.log(ocrBatch)
                const processedResults = await callGeminiAPI(prompt); // <-- ONE call
                
                // Step 4: Render Table
                statusText.textContent = "Done! Rendering table...";
                renderTable(processedResults); // <-- Pass the whole array of results
                resultsSection.classList.remove('hidden');
                statusContainer.classList.add('hidden');

            } catch (err) {
                console.error(err);
                statusText.textContent = `Error: ${err.message}`;
                alert(`An error occurred. Check the console for details.\nDid you set your API key correctly?`);
            } finally {
                setLoading(false);
            }
        });
        
        function setLoading(isLoading) {
            if (isLoading) {
                processButton.disabled = true;
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
            } else {
                processButton.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }

        // --- 7. NEW PDF-TO-IMAGE FUNCTION ---
        async function convertPdfPageToImage(pdfBytes) {
            // Load the PDF data into pdf.js
            const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
            const page = await pdf.getPage(1);
            
            const scale = 2.0; // Use a higher scale for better OCR quality
            const viewport = page.getViewport({ scale: scale });

            // Create an off-screen canvas
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // Render the PDF page onto the canvas
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            await page.render(renderContext).promise;

            // Convert canvas to a PNG data URL
            return canvas.toDataURL('image/png');
        }

        // --- 8. AI & PROMPT LOGIC ---
        function buildLLMBatchPrompt(ocrArray) {
            // Build the COA list for the prompt (same as before)
            const coaText = CHART_OF_ACCOUNTS_MAP.map(a => `- ${a.number}: ${a.name}`).join("\n");
            const categoriesText = PREFERRED_CATEGORIES.join("\n");
            
            // --- NEW: Build the batch text ---
            const batchText = ocrArray.map(receipt => {
                                return `--- RECEIPT ${receipt.id} ---
                ${receipt.text}
                `; // Add delimiters
                            }).join("\n"); // Join all receipts into one big string

                            return `
                You are an expert financial analyst. Analyze the raw OCR text from a BATCH of receipts.
                Each receipt is delimited by "--- RECEIPT [ID] ---".

                Respond *only* with a single valid JSON array, where each object corresponds to one receipt.
                The format MUST be:
                [
                {
                    "id": "ID_FROM_INPUT",
                    "vendor": "The merchant or store name (IN ALL CAPS)",
                    "total": "The final total amount as a number (e.g., 123.45)",
                    "currency": "The 3-letter currency code (MZN, USD, or ZAR). Default to MZN if unsure.",
                    "category": "The best matching category (IN ALL CAPS)",
                    "account_number": "The matching account number (e.g., '000 5170')"
                }
                ]

                Do not add markdown \`\`\`json or any commentary. Ensure the output is a single, valid JSON array.

                Here is your Chart of Accounts:
                ---
                ${coaText}
                ---

                Here are your 7 Preferred Categories:
                ---
                ${categoriesText}
                ---

                PROCEDURE:
                1.  Read the entire batch of OCR texts.
                2.  For *each* receipt, perform the following:
                3.  Find the vendor, total, currency.
                4.  Determine the purchase's purpose.
                5.  Match this purpose to the *best* account in the Chart of Accounts.
                6.  Match this purpose to the *best* category in the 7 Preferred Categories.
                7.  Add the resulting JSON object to the array, making sure the "id" matches the "--- RECEIPT [ID] ---".
                8.  Return the *single* JSON array.

                Here is the batch of OCR texts:
                ---
                ${batchText}
                ---
                `;
        }

        async function callGeminiAPI(prompt) {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${currentApiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`Gemini API Error: ${errorBody.error.message}`);
            }

            const data = await response.json();
            
            try {
                const jsonResponse = data.candidates[0].content.parts[0].text;
                // The AI should return an array. We parse it and return it directly.
                const results = JSON.parse(jsonResponse);
                if (!Array.isArray(results)) {
                    throw new Error("AI did not return an array.");
                }
                return results;
            } catch (err) {
                console.error("Failed to parse AI response:", data.candidates[0].content.parts[0].text, err);
                throw new Error("AI did not return valid JSON array. Check console for details.");
            }
        }

        // --- 9. UI & TABLE LOGIC ---
        function renderTable(results) {
            tableBody.innerHTML = ''; // Clear old results

            // --- NEW: Create a map of results for easy, ordered lookup ---
            const resultMap = new Map();
            if (Array.isArray(results)) {
                for (const result of results) {
                    resultMap.set(String(result.id), result); // Use string ID for safety
                }
            } else {
                console.error("Render error: AI results were not an array.", results);
            }

            // --- NEW: Loop from 0 to numPages to ensure correct order ---
            for (let index = 0; index < allPageBytes.length; index++) {
                // Get result from the map or an empty object if AI failed on this one
                const result = resultMap.get(String(index)) || {}; 
                
                const tr = document.createElement('tr');
                tr.setAttribute('data-index', index); // Link row to its PDF bytes
                tr.className = 'hover';

                // 1. Amount
                tr.innerHTML += `
                    <td>
                        <input class="input input-bordered input-sm w-full max-w-xs input-amount" type="text" value="${result.total || '0.00'}">
                    </td>
                `;

                // 2. Currency Dropdown
                const currencies = ['MZN', 'USD', 'ZAR'];
                let currencyOptions = currencies.map(c => 
                    `<option value="${c}" ${c === (result.currency || 'MZN') ? 'selected' : ''}>${c}</option>`
                ).join('');
                tr.innerHTML += `
                    <td>
                        <select class="select select-bordered select-sm w-full max-w-xs select-currency">
                            ${currencyOptions}
                        </select>
                    </td>
                `;

                // 3. Merchant
                tr.innerHTML += `
                    <td>
                        <input class="input input-bordered input-sm w-full max-w-xs input-vendor uppercase" type="text" value="${result.vendor || 'UNKNOWN'}">
                    </td>
                `;
                
                // 4. Line Item
                tr.innerHTML += `
                    <td>
                        <input class="input input-bordered input-sm w-full max-w-xs input-category uppercase" type="text" value="${result.category || 'GENERAL EXPENSE'}">
                    </td>
                `;
                
                // 5. Chart of Accounts Dropdown
                let coaOptions = CHART_OF_ACCOUNTS_MAP.map(a =>
                    `<option value="${a.number}" ${a.number === result.account_number ? 'selected' : ''}>${a.number} - ${a.name}</option>`
                ).join('');
                tr.innerHTML += `
                    <td>
                        <select class="select select-bordered select-sm w-full max-w-xs select-coa">
                            <option value="">-- Select --</option>
                            ${coaOptions}
                        </select>
                    </td>
                `;

                // 6. Preview Button
                tr.innerHTML += `
                    <td>
                        <button class="btn btn-sm btn-info btn-outline preview-button" data-index="${index}">
                            View
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(tr);
            }

            // Add event listeners to all new preview buttons
            document.querySelectorAll('.preview-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.currentTarget.getAttribute('data-index');
                    showPreview(index);
                });
            });
        }
        
        function showPreview(index) {
            try {
                const pdfBytes = allPageBytes[index];
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                pdfPreview.src = url;
                // Highlight the selected row
                document.querySelectorAll('#results-table-body tr').forEach(tr => {
                    tr.classList.remove('bg-primary', 'text-primary-content');
                });
                document.querySelector(`#results-table-body tr[data-index='${index}']`).classList.add('bg-primary', 'text-primary-content');
            } catch (err) {
                console.error("Preview error:", err);
                alert("Could not render PDF preview.");
            }
        }
        
        // --- 10. FINAL DOWNLOAD LOGIC ---

        downloadZipButton.addEventListener('click', async () => {
            statusContainer.classList.remove('hidden');
            statusText.textContent = "Generating ZIP file... please wait.";
            progressBar.removeAttribute('value'); // Indeterminate progress

            const zip = new JSZip();
            
            // Get all rows from the table *as they are now*
            const rows = document.querySelectorAll('#results-table-body tr');
            
            for (const row of rows) {
                const index = row.getAttribute('data-index');
                
                // Read current values from the form fields
                const amount = row.querySelector('.input-amount').value;
                const currency = row.querySelector('.select-currency').value;
                const vendor = row.querySelector('.input-vendor').value.toUpperCase();
                const category = row.querySelector('.input-category').value.toUpperCase();
                const coa = row.querySelector('.select-coa').value;
                
                // Sanitize account number for filename
                const coaSafe = coa.replace(/[\/*+ ]/g, '_'); 
                
                // Create the filename
                const filename = `${amount}-${currency} - ${vendor} - ${category} - ${coaSafe}.pdf`;
                
                // Get the original PDF bytes for this page
                const pdfBytes = allPageBytes[index];
                
                // Add to zip
                zip.file(filename, pdfBytes);
            }

            // Generate and trigger download
            try {
                const content = await zip.generateAsync({ type: "blob" });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = `Receipts_Export_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                statusText.textContent = "ZIP file generated!";
            } catch (err) {
                console.error("ZIP Error:", err);
                statusText.textContent = "Error generating ZIP file.";
            } finally {
                progressBar.setAttribute('value', '0'); // Reset progress
                statusContainer.classList.add('hidden');
            }
        });

        // --- 11. INITIALIZATION ---
        checkApiKey();
        
    </script>
</body>
</html>